name: Build APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ANDROID_HOME: /opt/android-sdk
  JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache Buildozer
      uses: actions/cache@v3
      with:
        path: |
          ~/.buildozer
          ~/.gradle
          /opt/android-sdk
        key: buildozer-${{ runner.os }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          buildozer-${{ runner.os }}-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          libffi-dev \
          libssl-dev \
          libpython3-dev \
          python3-dev \
          git \
          wget \
          unzip \
          openjdk-17-jdk \
          zlib1g-dev \
          libjpeg-dev
      env:
        DEBIAN_FRONTEND: noninteractive
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -q setuptools wheel
        pip install -q -r requirements.txt
    
    - name: Setup Android SDK
      run: |
        mkdir -p $ANDROID_HOME/licenses
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
        
        mkdir -p $ANDROID_HOME/cmdline-tools
        cd $ANDROID_HOME
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip -d cmdline-tools/
        mv cmdline-tools/cmdline-tools cmdline-tools/latest
        rm -f commandlinetools-linux-9477386_latest.zip
        
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        yes | sdkmanager --sdk_root=$ANDROID_HOME --licenses > /dev/null 2>&1 || true
        sdkmanager --sdk_root=$ANDROID_HOME "platforms;android-34" > /dev/null
        sdkmanager --sdk_root=$ANDROID_HOME "build-tools;34.0.0" > /dev/null  
        sdkmanager --sdk_root=$ANDROID_HOME "ndk;25.2.9519653" > /dev/null
        
        echo "Android SDK setup complete"
        echo "Platform tools: $(ls $ANDROID_HOME/platforms/)"
        echo "Build tools: $(ls $ANDROID_HOME/build-tools/)"
    
    - name: Prepare build
      run: |
        rm -rf .buildozer bin build
        mkdir -p bin
    
    - name: Build APK with Buildozer
      run: |
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        echo "Environment:"
        echo "  ANDROID_HOME=$ANDROID_HOME"
        echo "  JAVA_HOME=$JAVA_HOME"
        echo "  Python: $(python --version)"
        echo ""
        
        echo "Starting buildozer build..."
        buildozer android debug -v 2>&1 | tee build.log
        
        echo ""
        echo "Build exit code: $?"
    
    - name: Find and verify APK
      id: apk
      run: |
        echo "Searching for APK file..."
        
        # Search for APK in common locations
        APK=$(find . -name "*.apk" -type f -print -quit 2>/dev/null)
        
        if [ -z "$APK" ]; then
          echo "ERROR: APK not found!"
          echo ""
          echo "Directory search:"
          find . -type d -name "*build*" -o -type d -name "*bin*" 2>/dev/null | head -10
          echo ""
          echo "Last 50 lines of build log:"
          tail -50 build.log
          exit 1
        fi
        
        echo "Found APK: $APK"
        ls -lh "$APK"
        
        # Verify APK is valid
        if unzip -t "$APK" > /dev/null 2>&1; then
          echo "âœ“ APK is valid"
        else
          echo "ERROR: APK is corrupted"
          exit 1
        fi
        
        echo "APK_PATH=$APK" >> $GITHUB_OUTPUT
    
    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: calculator-apk
        path: ${{ steps.apk.outputs.APK_PATH  }}
        retention-days: 30
        if-no-files-found: error
    
    - name: Build diagnostics
      if: failure()
      run: |
        echo "=== BUILD FAILED - DIAGNOSTICS ==="
        echo ""
        echo "Last 100 lines of build.log:"
        tail -100 build.log || echo "No build.log found"
        echo ""
        echo "Android SDK status:"
        ls -lah $ANDROID_HOME 2>/dev/null || echo "ANDROID_SDK not found"
        echo ""
        echo "Installed packages:"
        pip list | grep -E "kivy|buildozer|cython"
